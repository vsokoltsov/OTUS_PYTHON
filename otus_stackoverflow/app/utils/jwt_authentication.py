from rest_framework import authentication
from rest_framework import exceptions
from jwt.exceptions import (
    DecodeError, InvalidSignatureError, ExpiredSignatureError
)

from user.models import User
import app.utils.jwt as jwt


class JWTAuthentication(authentication.BaseAuthentication):
    """Custom authentication class based on jwt."""

    HEADER = 'OTUS'

    def authenticate(self, request):
        """Return authenticated user based on header."""

        hash_string = request.META.get(self.HEADER)
        if not hash_string:
            return None

        try:
            user = jwt.decode(hash_string)
            user = User.objects.get(id=user.get('id'))
        except DecodeError:
            raise exceptions.AuthenticationFailed('Cannot decode give token')
        except ExpiredSignatureError:
            raise exceptions.AuthenticationFailed(
                'Authentication token has expired'
            )
        except InvalidSignatureError:
            raise exceptions.AuthenticationFailed(
                'Does not match with a signature'
            )
        except User.DoesNotExist:
            raise exceptions.AuthenticationFailed('No such user')

        return (user, None)
